# 施工设计稿：md_gateway ⇄ trade_app 共享内存快照（SeqLock）

> 参考：`gate_result/review.md` 的“必须写清”项。  
> 本稿定位：把 IPC 方案拆成可落地的 **框架/接口清单 + 施工步骤 + 验收点**（不要求本阶段写具体实现代码）。

---

## 0. 本阶段输出物（你要的“框架搭建”）

- 设计文档：
  - `gate_result/设计.md`（规范：职责/布局/协议/启动/故障语义）
  - `gate_result/施工设计稿.md`（本文：任务拆分与验收点）
- ABI/接口骨架（只定义，不要求实现）：
  - `gate_result/header.h`：`ShmHeader` 字段（你已写）
  - `gate_result/struct_def.h`：`SnapshotEntry`/payload/SeqLock 协议（对齐与尺寸约束）
  - `gate_result/shm_writer.h`：writer 侧接口大纲
  - `gate_result/shm_reader.h`：reader 侧接口大纲

---

## 1. 目标

- `md_gateway` **唯一登录 TDF**，接收 SDK 回调
- 建立 `wind_code -> symbol_id` 映射（3000 个标的，`MarketData` 对齐后 320B）
- 创建命名共享内存段：`Header + entries[3000]`（快照表）
- `trade_app` 不连接 TDF，只读共享内存快照表做策略决策与交易

---

## 2. 方案总览

### 2.1 数据平面：共享内存快照表（Snapshot Table）

- 布局：`ShmHeader + SnapshotEntry entries[3000]`
- 每个 `SnapshotEntry`：
  - `seq`：SeqLock 计数（odd=写中，even=稳定）
  - `payload`：`MarketData(320B)`
  - `padding/meta`：保证 payload 64B 对齐，减少 false sharing

### 2.2 写入路径（gateway）

- 基线：回调线程直接 SeqLock 写 `entries[symbol_id]`
- 推荐：回调线程只入队（可选 SPSC），writer 线程批量刷 shm，保证 **单写者**、减少回调抖动

### 2.3 读取路径（trade_app）

- 启动后 mmap 一次常驻
- 策略循环（每秒/每 3 秒）：按 `symbol_id` 读关注标的快照（SeqLock 读协议）
- 交易调用串行化：保留 queued trading（避免多线程调用交易 API）

---

## 3. 必须写清的协议与语义（施工验收点）

### 3.1 进程划分与职责（验收：文档覆盖）

- gateway：TDF 连接/订阅/映射/写 shm/心跳
- trade：读 shm/策略循环/交易串行化/健康检测与降级

### 3.2 共享内存布局（验收：字段清单明确）

Header 必须包含（最小集）：

- `magic/abi_version/header_bytes/total_bytes/endian`
- `writer_start_ns`（epoch）与 `heartbeat_ns`
- `symbol_count(=3000)` 与 `snapshot_offset/bytes/entry_bytes/payload_bytes(=320)` 与 `snapshot_mode`
- `md_status/last_err/last_md_ns`

SnapshotEntry 必须包含（最小集）：

- `seq` + `payload(320B)` + 对齐 padding（建议总 entry=384B）

### 3.3 读写协议（验收：伪代码一致）

- 写：`seq` odd → memcpy payload → `seq` even（发布）
- 读：读两次 `seq`，若 odd 或两次不一致则重试

### 3.4 启动顺序（验收：trade 侧有明确策略）

- gateway 先启动并创建 shm
- trade_app 启动时：
  - shm 不存在：等待/退出（明确策略）
  - shm 存在：校验 header 后运行；heartbeat 异常则进入禁交易/等待恢复

### 3.5 故障语义（验收：trade 侧明确降级动作）

- heartbeat 超时：trade 进入降级（暂停策略/禁止下单/仅撤单等）
- gateway 重启：`writer_start_ns` 变化 → trade 重同步（重开 shm/重建映射/清空缓存）
- TDF 断线：gateway 设置 `md_status` 与 `last_err`；trade 依据状态进入降级

---

## 4. “框架搭建”任务拆分（给 CLI 的任务颗粒度）

> 这里是模块边界与接口，便于后续拆任务；本阶段不要求实现细节。

### 4.1 新增进程：md_gateway

- 启动流程骨架：读 config → 建映射 → create shm → connect TDF → run
- 回调入口只做：定位 `symbol_id` +（可选）入队；不做 mutex/map 频繁操作

### 4.2 新增共享内存模块：shm_md（writer/reader）

- writer API：create/init/open、写 entry、刷 heartbeat、写状态
- reader API：open/validate、读 entry（SeqLock）、读健康字段

### 4.3 trade_app 增加行情适配器：ShmMarketDataApi

- 对外接口保持与现有策略代码兼容（`get_snapshot(symbol)` 或 `get_snapshot(symbol_id)`）
- 内部实现来源改为 shm（替换 TDF 连接）
- 与交易侧 queued trading 解耦：行情读是无锁读，交易仍走串行队列

---

## 5. 关键决策点（施工前必须定死）

1) **symbol_id 的权威来源**

- 方案 A：以订阅 CSV 的顺序为准（gateway/trade 使用同一 CSV）
- 方案 B：在 shm 增加 symbol_dir（id->wind_code/hash），trade 启动时从 shm 构建映射（更稳）

建议：若担心“CSV 不一致”风险，优先方案 B（不影响热路径）。

2) **TDF 回调线程模型**

- 若确认回调单线程：SPSC 可用
- 若回调多线程：需要 MPSC 或“每回调线程一个 SPSC + writer 轮询”以保持 shm 单写者

3) **是否需要严格无数据竞争**

- SeqLock + 非原子 payload 在严格 ISO C++ 语义下有争议；工程上通常可用
- 若要更“严格”：后续切换为 entry 双缓冲（两个 payload + active/version）

---

## 6. 验收清单（不写具体代码也能验的）

- 文档验收：`gate_result/设计.md` 覆盖 review.md 的 A 项全部章节
- ABI 验收：明确 `payload=320B`、`entry=384B`、`entries[3000]` 的总字节数估算
- 协议验收：读写伪代码与内存序（acquire/release）写清楚
- 故障验收：trade 的降级策略与重启检测条件写清楚

